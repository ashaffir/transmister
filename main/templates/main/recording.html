{% extends 'main/base.html' %}
{% load static %}
{% block css %}
<link href="{% static 'css/mystyle.css' %}" rel="stylesheet">
{% endblock css %}
{% block content %}
<div id="loader-container">
    <div id="loader-content">
        <p id="loader-text"></p>
        <button id="stop-btn" style="display: none;" class="btn btn-lg btn-warning">Stop Recording</button>
        <span id="recording-time" style="margin-left: 10px;"></span>
        <div id="loader"></div>
    </div>
</div>
<div class="row">
    <div class="col-sm-12 col-lg-12 col-md-12 col-12">
        <h1>Record and transcribe</h1>
        <h4>Session: {{ session.id }}</h4>
    </div>
</div>
<div class="row mb-5">
    <div class="col-sm-12 col-lg-12 col-md-12 col-12">
        <button id="record-button" class="record_button">Record</button>
    </div>
</div>
<div class="row mb-5">
    <div class="col-12 col-sm-12 col-lg-12 col-md-12" id="recordings">
        <style>
            .recording {
                font-size: 2rem;
            }
        </style>

        <table class="table">
            <thead>
                <th>Recording Time</th>
                <th></th>
                <th></th>
            </thead>
            <tbody>
                {% for record in recordings %}
                <tr>
                    <td>
                        {{ record.created }}
                    </td>
                    <td>
                        <a href="{{ record.voice_recording.url }}">
                            <i class="fa fa-play-circle-o fa-2x"></i>
                        </a>
                    </td>
                    <td>
                        <a href="#">
                            <i class="fa fa-trash fa-2x" onclick="deleteRecording('{{ record.id }}')"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div class="row" style="margin-top: 2rem; margin-bottom: 2rem;">
    <div class="col-sm-12 col-lg-12 col-md-12 col-12">

        <button id="runButton" onclick="transcribeRecording()" class="transcribe_button">
            Transcribe
        </button>

    </div>
</div>

<div class="row w-100">
    <div class="col-12">
        <div class="x_panel">
            <div class="x_title">
                <h2>Audio text</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="bs-example" data-example-id="simple-jumbotron">
                    <div class="jumbotron" id="transcription_result" dir="rtl">

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    {% include 'main/modals/confirm_clear_session_modal.html' %}

    <div class="col-sm-12 col-lg-12 col-md-12 col-12">
        <button class="btn btn-danger" data-toggle="modal" data-target="#modal_confirm_clear_session">
            Reset/Restart Session</button>
        <i class="fa fa-question-circle fa-2x" data-toggle="tooltip" data-placement="top"
            title="Deleting the recordings in the current session"></i>
    </div>
</div>
<form action="" enctype="multipart/form-data" method="post">
    {% csrf_token %}
</form>
{% endblock %}

{% block js %}


<script src="{% static 'js/myjs.js' %}"></script>
<script>
    var recording = false;
    var mediaRecorder;
    var chunks = [];
    var timer = null;
    var recordingTime = 0;

    function getFileExtension(mimeType) {
        switch (mimeType) {
            case 'audio/wav':
                return 'wav';
            case 'audio/webm':
                return 'webm';
            case 'audio/ogg':
                return 'ogg';
            case 'audio/mp4':
                return 'mp4';
            default:
                return 'unknown';
        }
    }

    function startRecording() {
        console.log(`START...`);
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function (stream) {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.addEventListener("dataavailable", function (event) {
                    chunks.push(event.data);
                });
                mediaRecorder.addEventListener("stop", function () {
                    var blob = new Blob(chunks, { type: mediaRecorder.mimeType });
                    clearInterval(timer);
                    recordingTime = 0;
                    var formData = new FormData();
                    formData.append("audio_blob", blob, "recording." + getFileExtension(mediaRecorder.mimeType));
                    formData.append("csrfmiddlewaretoken", document.querySelector('[name=csrfmiddlewaretoken]').value)
                    formData.append("device", mediaRecorder.mimeType)
                    $.ajax({
                        url: "{% url 'main:upload' session_id=session.id %}",
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function () {
                            chunks = [];
                        }
                    });
                });
                mediaRecorder.start();
                recording = true;
                startTimer();
            });
    }

    function stopRecording() {
        console.log(`STOP!`);
        mediaRecorder.stop();
        clearInterval(timer);
        recordingTime = 0;
        recording = false;
        pollForNewRecording();
    }

    function pollForNewRecording() {
        console.log(`polling...`);
        const url = "{% url 'main:check-recordings' session_id=session.id current_count=session.get_current_count %}";
        $.ajax({
            url: url,
            type: "GET",
            success: function (response) {
                if (response.success) {
                    location.reload();
                } else {
                    console.log(`Waiting...`);
                    setTimeout(pollForNewRecording, 1000); // Poll every 1 second
                }
            }
        });
    }

    function startTimer() {
        timer = setInterval(function () {
            recordingTime++;
            document.getElementById("recording-time").innerText = "Recording time: " + recordingTime + " seconds";
        }, 1000);
    }

</script>
<script>
    const transcription_result_el = document.getElementById("transcription_result");

    function transcribeRecording() {
        showLoader('Transcribing...');
        const url = "{% url 'main:transcribe' session_id=session.id %}";
        var formData = new FormData();
        formData.append("csrfmiddlewaretoken", document.querySelector('[name=csrfmiddlewaretoken]').value)
        $.ajax({
            url: url,
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (message) {
                if (message.success) {
                    console.log(`M = ${message}`);
                    transcription_result_el.innerHTML = message.content;
                    hideLoader();
                    // location.reload();
                }
                else {
                    console.log(`>>> ${message.success}`);
                    alert("Error transcribing. Contact support");
                }
            }
        });
    }

</script>

<script>
    function clearSessionRecordings() {
        url = "{% url 'main:clear-session' session_id=session.id %}";
        $.ajax({
            url: url,
            method: "GET",
            success: function (message) {
                if (message.success) {
                    console.log(`Delete success`);
                    location.reload();
                } else {
                    console.log(`FAIL to delete`);
                }
            }
        })

    }
</script>

<script>
    function deleteRecording(recordingId) {
        url = `{% url 'main:delete-recording' %}?recording_id=${recordingId}`;
        $.ajax({
            url: url,
            method: "GET",
            success: function (response) {
                if (response.success) {
                    console.log(`OK`);
                    location.reload();
                }
            }
        })
    }
</script>
{% endblock js %}